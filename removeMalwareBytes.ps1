# NinjaOne Script - Malwarebytes Compliance Removal
# Run As: SYSTEM | Architecture: All

$silentArgs = "/verysilent /suppressmsgboxes /norestart /clean"

# Define possible paths for different versions
$paths = @(
    "${env:ProgramFiles}\Malwarebytes\Anti-Malware\unins000.exe",
    "${env:ProgramFiles(x86)}\Malwarebytes\Anti-Malware\unins000.exe",
    "${env:ProgramFiles}\Malwarebytes\Anti-Malware\mbuns.exe",
    "${env:ProgramFiles(x86)}\Malwarebytes\Anti-Malware\mbuns.exe"
)

Write-Host "Compliance Check: Initiating Malwarebytes Removal..."

# 1. Attempt Path-Based Removal (Fastest)
foreach ($path in $paths) {
    if (Test-Path $path) {
        Write-Host "Found uninstaller at $path. Executing silent removal..."
        Start-Process -FilePath $path -ArgumentList $silentArgs -Wait -ErrorAction SilentlyContinue
    }
}

# 2. Attempt Registry-Based Removal (Catch-all)
$registryPaths = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*"
)

$apps = Get-ItemProperty $registryPaths | Where-Object { $_.DisplayName -match "Malwarebytes" }

foreach ($app in $apps) {
    if ($app.UninstallString -match "msiexec") {
        $guid = ($app.UninstallString -split " ")[1]
        Write-Host "Removing MSI-based Malwarebytes ($($app.DisplayName))..."
        # If you have an uninstall password, add Password="YOUR_PW" to the end of ArgumentList
        Start-Process "msiexec.exe" -ArgumentList "/x $guid /qn /norestart" -Wait
    }
}

Write-Host "Removal process complete. Verifying status..."

# Final check for compliance reporting
if (Test-Path "C:\Program Files\Malwarebytes") {
    Write-Error "Compliance Failure: Malwarebytes directory still exists."
    exit 1
} else {
    Write-Host "Compliance Success: Malwarebytes removed."
    exit 0
}